{"version":3,"file":"index.js","sourceRoot":"","sources":["../src/index.ts"],"names":[],"mappings":";;;;;;AAAA,oDAAsB;AAEtB,IAAY,WAGX;AAHD,WAAY,WAAW;IACtB,0BAAW,CAAA;IACX,0BAAW,CAAA;AACZ,CAAC,EAHW,WAAW,GAAX,mBAAW,KAAX,mBAAW,QAGtB;AAED,IAAY,UAOX;AAPD,WAAY,UAAU;IACrB,wBAAU,CAAA;IACV,0BAAY,CAAA;IACZ,0BAAY,CAAA;IACZ,wBAAU,CAAA;IACV,yBAAW,CAAA;IACX,wBAAU,CAAA;AACX,CAAC,EAPW,UAAU,GAAV,kBAAU,KAAV,kBAAU,QAOrB;AAgCD,MAAa,SAAS;IAuCrB,wBAAwB;IAExB,YAAmB,KAAc,EAAE,MAAgB;QAElD,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC,CAAC,CAAC,gBAAC,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,mBAAmB,EAAE,CAAA;QAC1E,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC,CAAC,CAAC,gBAAC,CAAC,SAAS,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,oBAAoB,EAAE,CAAA;IAE/E,CAAC;IAvCD,IAAW,KAAK,KAAK,OAAO,IAAI,CAAC,MAAM,CAAA,CAAC,CAAC;IACzC,IAAW,KAAK,CAAC,GAAW,IAAI,IAAI,CAAC,MAAM,GAAG,GAAG,CAAA,CAAC,CAAC;IAEnD,IAAW,MAAM,KAAK,OAAO,IAAI,CAAC,OAAO,CAAA,CAAC,CAAC;IAC3C,IAAW,MAAM,CAAC,GAAY,IAAI,IAAI,CAAC,OAAO,GAAG,GAAG,CAAA,CAAC,CAAC;IAEtD,yBAAyB;IAEjB,MAAM,CAAC,aAAa,CAAC,MAAqB,EAAE,MAAqB;QACxE,IAAI,MAAM,KAAK,IAAI,IAAI,MAAM,KAAK,IAAI;YAAE,OAAO,KAAK,CAAA;aAC/C,IAAI,MAAM,CAAC,IAAI,KAAK,MAAM,CAAC,IAAI,IAAI,MAAM,CAAC,KAAK,KAAK,MAAM,CAAC,KAAK;YAAE,OAAO,IAAI,CAAA;;YAC7E,OAAO,KAAK,CAAA;IAClB,CAAC;IAEO,MAAM,CAAC,WAAW,CAAC,QAAmB;QAC7C,IACC,QAAQ,CAAC,GAAG,GAAG,CAAC;YAChB,QAAQ,CAAC,GAAG,GAAG,CAAC;YAChB,QAAQ,CAAC,GAAG,GAAG,CAAC;YAChB,QAAQ,CAAC,GAAG,GAAG,CAAC;YACf,OAAO,KAAK,CAAA;;YACT,OAAO,IAAI,CAAA;IACjB,CAAC;IAEO,aAAa,CAAC,KAAkB;QACvC,MAAM,OAAO,GAAG,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,WAAW,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC,CAAA;QAC7I,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,UAAU,CAAC,IAAI,EAAE,KAAK,EAAE,EAAE,KAAK,CAAC,CAAC,CAAC,CAAC,CAAA;QAElE,IAAI,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC;YAAE,OAAO,IAAI,CAAA;;YAC3C,OAAO,KAAK,CAAA;IAClB,CAAC;IAWM,QAAQ,CAAC,QAAmB,EAAE,oBAA6B,IAAI,EAAE,eAAwB,IAAI;QAEnG,IAAI,YAAY,GAAgB,EAAE,CAAA;QAClC,MAAM,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC,QAAQ,CAAC,CAAA;QAEvC,IAAI,CAAC,KAAK;YAAE,OAAO,YAAY,CAAA;QAE/B,MAAM,MAAM,GAAG,CAAC,CAAS,EAAE,CAAS,EAAE,EAAE,CAAC,CAAC,EAAC,GAAG,EAAE,CAAC,EAAE,GAAG,EAAE,CAAC,EAAE,CAAC,CAAA;QAE5D,MAAM,cAAc,GAAG,CAAC,WAAsB,EAAE,YAAY,GAAG,IAAI,EAAW,EAAE;YAC/E,kIAAkI;YAElI,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,WAAW,CAAC;gBAAE,OAAO,KAAK,CAAA;YACrD,MAAM,UAAU,GAAG,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAA;YAE/C,IAAI,CAAC,UAAU,EAAE;gBAChB,YAAY,CAAC,IAAI,CAAC,WAAW,CAAC,CAAA;gBAC9B,OAAO,IAAI,CAAA;aACX;iBACI,IAAI,CAAC,UAAU,CAAC,KAAK,KAAK,KAAK,CAAC,KAAK,CAAC,IAAI,YAAY,EAAE;gBAC5D,YAAY,CAAC,IAAI,CAAC,WAAW,CAAC,CAAA;gBAC9B,OAAO,KAAK,CAAA;aACZ;;gBACI,OAAO,KAAK,CAAA;QAClB,CAAC,CAAA;QAED,MAAM,eAAe,GAAG,GAAG,EAAE;YAC5B,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC1C,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,CAAC;oBAAE,MAAK;aACnD;YACD,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC3C,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,CAAC;oBAAE,MAAK;aACnD;YACD,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC1C,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;oBAAE,MAAK;aACnD;YACD,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,IAAI,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC3C,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,CAAC,CAAC;oBAAE,MAAK;aACnD;QACF,CAAC,CAAA;QAED,MAAM,eAAe,GAAG,GAAG,EAAE;YAC5B,MAAM,MAAM,GAAG,CAAC,CAAS,EAAE,CAAS,EAAE,EAAE,CAAC,CAAC,EAAC,GAAG,EAAE,CAAC,EAAE,GAAG,EAAE,CAAC,EAAE,CAAC,CAAA;YAE5D,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,EAAE,EAAE;gBAClF,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;oBAAE,MAAK;aACxC;YACD,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,EAAE,EAAE;gBACpF,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;oBAAE,MAAK;aACxC;YACD,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,EAAE,EAAE;gBACnF,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;oBAAE,MAAK;aACxC;YACD,KAAK,IAAI,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,GAAG,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,CAAC,GAAG,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,EAAE,EAAE;gBACnF,IAAI,CAAC,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;oBAAE,MAAK;aACxC;QACF,CAAC,CAAA;QAED,kBAAkB;QAElB,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,EAAE;YACnC,eAAe,EAAE,CAAA;SACjB;aAEI,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,MAAM,EAAE;YAC1C,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;SAC1D;aAEI,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,MAAM,EAAE;YAC1C,eAAe,EAAE,CAAA;SACjB;aAEI,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,EAAE;YACxC,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAA;YACtD,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,CAAC,CAAA;YACtD,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YACtD,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YACtD,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAC1D,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;YAE1D,SAAS;YACT,IAAI,iBAAiB,EAAE;gBACtB,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,EAAE;oBACtC,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,EAAE;wBAClE,MAAM,QAAQ,GAAG,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC,CAAA;wBAE5F,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,iBAAiB,EAAE;4BACzC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE;gCAC/C,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;oCAAE,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE,KAAK,CAAC,CAAA;6BAC3E;yBACD;wBACD,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,gBAAgB,EAAE;4BACxC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE;gCACtE,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;oCAAE,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE,KAAK,CAAC,CAAA;6BAC9F;yBACD;qBACD;iBACD;qBAEI;oBACJ,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,OAAO,EAAE;wBAClE,MAAM,QAAQ,GAAG,SAAS,CAAC,cAAc,CAAC,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,CAAC,CAAA;wBAE5F,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,iBAAiB,EAAE;4BACzC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE;gCAC/C,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;oCAAE,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE,KAAK,CAAC,CAAA;6BAC3E;yBACD;wBACD,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,gBAAgB,EAAE;4BACxC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE;gCACtE,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;oCAAE,cAAc,CAAC,MAAM,CAAC,CAAC,EAAE,CAAC,CAAC,EAAE,KAAK,CAAC,CAAA;6BAC9F;yBACD;qBACD;iBACD;aACD;SAED;aAEI,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,KAAK,EAAE;YACzC,eAAe,EAAE,CAAA;YACjB,eAAe,EAAE,CAAA;SACjB;aAEI,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,EAAE;YAExC,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,EAAE;gBAEtC,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,EAAE,KAAK,CAAC,CAAA;gBAC7D,IAAI,QAAQ,CAAC,GAAG,KAAK,CAAC;oBAAE,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,EAAE,KAAK,CAAC,CAAA;gBAErF,IAAI,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;gBACjE,IAAI,UAAU,IAAI,UAAU,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;oBAAE,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;gBAEpH,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;gBAC7D,IAAI,UAAU,IAAI,UAAU,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;oBAAE,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;gBAEpH,aAAa;gBACb,IAAI,iBAAiB,IAAI,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE;oBAC5C,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;oBACzD,IACC,UAAU;wBACV,UAAU,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;wBACtC,UAAU,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI;wBACnC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC;wBAC/C,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;oBAE5D,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;oBACzD,IACC,UAAU;wBACV,UAAU,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;wBACtC,UAAU,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI;wBACnC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC;wBAC/C,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;iBAC5D;aAED;iBAEI;gBAEJ,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,EAAE,KAAK,CAAC,CAAA;gBAC7D,IAAI,QAAQ,CAAC,GAAG,KAAK,CAAC;oBAAE,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,CAAC,EAAE,KAAK,CAAC,CAAA;gBAErF,IAAI,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;gBACjE,IAAI,UAAU,IAAI,UAAU,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;oBAAE,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;gBAEpH,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;gBAC7D,IAAI,UAAU,IAAI,UAAU,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;oBAAE,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;gBAEpH,aAAa;gBACb,IAAI,iBAAiB,IAAI,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE;oBAC5C,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;oBACzD,IACC,UAAU;wBACV,UAAU,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;wBACtC,UAAU,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI;wBACnC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC;wBAC/C,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;oBAE5D,UAAU,GAAG,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;oBACzD,IACC,UAAU;wBACV,UAAU,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;wBACtC,UAAU,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI;wBACnC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,YAAY,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC;wBAC/C,cAAc,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,EAAE,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAA;iBAC5D;aAED;SAED;QAED,iDAAiD;QAEjD,IAAI,YAAY,EAAE;YACjB,MAAM,eAAe,GAAG,CAAC,aAAwB,EAAE,WAAsB,EAAE,EAAE;gBAC5E,MAAM,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC,aAAa,CAAE,EAAE,EAAE,GAAG,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAA;gBAE7E,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,EAAE,CAAA;gBAClD,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,IAAI,CAAA;gBAExD,IAAI,UAAU,GAAG,KAAK,CAAA;gBACtB,IAAI,CAAC,IAAI,CAAC,aAAa,CAAC,EAAE,CAAC,KAAK,CAAC;oBAAE,UAAU,GAAG,IAAI,CAAA;gBAEpD,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,EAAE,CAAA;gBAClD,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,EAAE,CAAA;gBAEtD,OAAO,UAAU,CAAA;YAClB,CAAC,CAAA;YACD,YAAY,GAAG,YAAY,CAAC,MAAM,CAAC,WAAW,CAAC,EAAE,CAAC,eAAe,CAAC,QAAQ,EAAE,WAAW,CAAC,CAAC,CAAA;SACzF;QAED,WAAW;QAEX,OAAO,YAAY,CAAA;IAEpB,CAAC;IAEM,WAAW,CAAC,KAAkB,EAAE,oBAA6B,IAAI,EAAE,eAAwB,IAAI;QACrG,IAAI,YAAY,GAAgB,EAAE,CAAA;QAElC,KAAI,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;YAC1B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC3B,MAAM,KAAK,GAAG,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,CAAC,CAAC,CAAA;gBAChC,IAAI,KAAK,IAAI,KAAK,CAAC,KAAK,KAAK,KAAK,EAAE;oBACnC,YAAY,CAAC,IAAI,CAAC,GAAG,IAAI,CAAC,QAAQ,CAAC,EAAC,GAAG,EAAE,CAAC,EAAE,GAAG,EAAE,CAAC,EAAC,EAAE,iBAAiB,EAAE,YAAY,CAAC,CAAC,CAAA;iBACtF;aACD;SACD;QAED,OAAO,YAAY,CAAA;IACpB,CAAC;IAEM,QAAQ,CAAC,aAAwB,EAAE,WAAsB,EAAE,eAAwB,IAAI;QAE7F,6BAA6B;QAC7B,gCAAgC;QAChC,sBAAsB;QACtB,oBAAoB;QAEpB,UAAU;QACV,MAAM,KAAK,GAAG,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,CAAA;QAC5C,IAAI,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAA;QAChD,IAAI,CAAC,KAAK;YAAE,OAAO,KAAK,CAAA;QAExB,UAAU;QACV,MAAM,QAAQ,GAAG,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,WAAW,CAAC,KAAK,CAAA;QAC1F,MAAM,WAAW,GAAG,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAA;QACzE,MAAM,YAAY,GAAG,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAA;QAE1E,SAAS;QACT,IAAI,YAAY,IAAI,IAAI,CAAC,OAAO,CAAC,WAAW,KAAK,KAAK,CAAC,KAAK;YAAE,OAAO,KAAK,CAAA;QAC1E,MAAM,KAAK,GAAG,IAAI,CAAC,QAAQ,CAAC,aAAa,EAAE,IAAI,CAAC,CAAA;QAChD,MAAM,YAAY,GAAG,SAAS,CAAC,cAAc,CAAC,KAAK,CAAC,CAAA;QACpD,IAAI,CAAC,YAAY,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC;YAAE,OAAO,KAAK,CAAA;QAEjE,SAAS;QACT,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,KAAK,CAAA;QACrD,IAAI,CAAC,MAAM,CAAC,aAAa,CAAC,GAAG,CAAC,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,IAAI,CAAA;QAExD,kEAAkE;QAClE,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,EAAE;YACnC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,YAAY,EAAE;gBAC7C,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,EAAE;oBAC1B,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,EAAE,IAAI,EAAE,UAAU,CAAC,IAAI,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,EAAE,CAAA;oBACzG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,IAAI,CAAA;oBAChE,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,iBAAiB,GAAG,IAAI,CAAA;iBACnD;qBACI,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,EAAE;oBAC/B,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,EAAE,IAAI,EAAE,UAAU,CAAC,IAAI,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,EAAE,CAAA;oBACzG,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,IAAI,CAAA;oBAChE,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,gBAAgB,GAAG,IAAI,CAAA;iBAClD;aACD;YACD,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,YAAY,GAAG,IAAI,CAAA;SAC9C;aACI,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,EAAE;YACxC,IAAI,aAAa,CAAC,GAAG,KAAK,CAAC;gBAAE,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,gBAAgB,GAAG,IAAI,CAAA;iBAC1E,IAAI,aAAa,CAAC,GAAG,KAAK,CAAC;gBAAE,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,iBAAiB,GAAG,IAAI,CAAA;SACrF;QAED,kEAAkE;QAClE,IAAI,aAAa,IAAI,aAAa,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,EAAE;YAC5D,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,iBAAiB,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,EAAE;gBAC1E,IAAI,CAAC,QAAQ,KAAK,WAAW,CAAC,KAAK,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,CAAC;oBAC5D,CAAC,QAAQ,KAAK,WAAW,CAAC,KAAK,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,CAAC;oBAAE,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,iBAAiB,GAAG,IAAI,CAAA;aAC9G;iBACI,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,gBAAgB,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,EAAE;gBAC9E,IAAI,CAAC,QAAQ,KAAK,WAAW,CAAC,KAAK,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,CAAC;oBAC5D,CAAC,QAAQ,KAAK,WAAW,CAAC,KAAK,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,CAAC;oBAAE,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,gBAAgB,GAAG,IAAI,CAAA;aAC7G;SACD;QAED,wCAAwC;QACxC,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,EAAE;YAEnC,+BAA+B;YAC/B,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,EAAE;gBACtC,IAAI,aAAa,CAAC,GAAG,KAAK,CAAC,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC;oBAAE,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,YAAY,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,IAAI,CAAA;;oBAClH,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,YAAY,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,KAAK,CAAA;aACvE;iBACI;gBACJ,IAAI,aAAa,CAAC,GAAG,KAAK,CAAC,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC;oBAAE,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,YAAY,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,IAAI,CAAA;;oBAClH,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,YAAY,CAAC,aAAa,CAAC,GAAG,CAAC,GAAG,KAAK,CAAA;aACvE;YAED,qBAAqB;YACrB,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,EAAE;gBACtC,IAAI,aAAa,CAAC,GAAG,KAAK,CAAC;oBAC1B,WAAW,CAAC,GAAG,KAAK,CAAC;oBACrB,CAAC,aAAa;oBACd,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,YAAY,CAAC,WAAW,CAAC,GAAG,CAAC;oBACvD,CAAC,WAAW,CAAC,GAAG,KAAK,aAAa,CAAC,GAAG,GAAG,CAAC;wBAC1C,WAAW,CAAC,GAAG,KAAK,aAAa,CAAC,GAAG,GAAG,CAAC,CAAC,EAAE;oBAE5C,MAAM,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,WAAW,CAAC,GAAG,CAAC,CAAA;oBACpD,IAAI,WAAW;wBACd,WAAW,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI;wBACpC,WAAW,CAAC,KAAK,KAAK,QAAQ,EAAE;wBAC/B,aAAa,GAAG,WAAW,CAAA;wBAC3B,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,IAAI,CAAA;qBACtC;iBACF;aACD;iBACI;gBACJ,IAAI,aAAa,CAAC,GAAG,KAAK,CAAC;oBAC1B,WAAW,CAAC,GAAG,KAAK,CAAC;oBACrB,CAAC,aAAa;oBACd,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,YAAY,CAAC,WAAW,CAAC,GAAG,CAAC;oBACvD,CAAC,WAAW,CAAC,GAAG,KAAK,aAAa,CAAC,GAAG,GAAG,CAAC;wBAC1C,WAAW,CAAC,GAAG,KAAK,aAAa,CAAC,GAAG,GAAG,CAAC,CAAC,EAAE;oBAE5C,MAAM,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,CAAC,EAAE,WAAW,CAAC,GAAG,CAAC,CAAA;oBACpD,IAAI,WAAW;wBACd,WAAW,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI;wBACpC,WAAW,CAAC,KAAK,KAAK,QAAQ,EAAE;wBAC/B,aAAa,GAAG,WAAW,CAAA;wBAC3B,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,IAAI,CAAA;qBACtC;iBACF;aACD;YAED,oBAAoB;YACpB,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,EAAE;gBAC/D,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,EAAE,IAAI,EAAE,UAAU,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,EAAC,CAAA;aAC7F;iBACI,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,IAAI,WAAW,CAAC,GAAG,KAAK,CAAC,EAAE;gBACpE,IAAI,CAAC,MAAM,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,EAAE,IAAI,EAAE,UAAU,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,KAAK,EAAC,CAAA;aAC7F;SAED;QAED,oCAAoC;QACpC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,YAAY,GAAG,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC,CAAA;QAEjG,iDAAiD;QACjD,IAAI,IAAI,CAAC,WAAW,CAAC,QAAQ,EAAE,IAAI,CAAC,CAAC,MAAM,KAAK,CAAC,EAAE;YAClD,IAAI,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,EAAE;gBACjC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,OAAO,GAAG,IAAI,CAAA;gBACxC,IAAI,CAAC,OAAO,CAAC,WAAW,GAAG,IAAI,CAAA;aAC/B;;gBACI,IAAI,CAAC,OAAO,CAAC,WAAW,GAAG,IAAI,CAAA;SACpC;aACI,IAAI,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,EAAE;YACtC,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,CAAC,OAAO,GAAG,IAAI,CAAA;SACxC;QAED,sCAAsC;QACtC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,OAAO,GAAG,KAAK,CAAA;QAEnF,2BAA2B;QAC3B,IAAI,CAAC,OAAO,CAAC,WAAW,GAAG,QAAQ,CAAA;QAEnC,WAAW;QACX,OAAO,aAAa,CAAA;IAErB,CAAC;IAEM,IAAI,CAAC,KAAa,EAAE,UAAmB,KAAK;QAClD,IAAI,YAAY,GAAgB,EAAE,CAAA;QAElC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;YAC3B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE;gBAC3B,IAAI,SAAS,CAAC,aAAa,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,KAAK,CAAC,EAAE;oBACtD,YAAY,CAAC,IAAI,CAAC,EAAC,GAAG,EAAE,CAAC,EAAE,GAAG,EAAE,CAAC,EAAC,CAAC,CAAA;oBACnC,IAAI,CAAC,OAAO;wBAAE,OAAO,YAAY,CAAA;iBACjC;aACD;SACD;QAED,OAAO,YAAY,CAAA;IACpB,CAAC;IAEM,UAAU,CAAC,QAAmB;QACpC,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAA;IAC/C,CAAC;IAEM,OAAO,CAAC,GAAW,EAAE,GAAW;QACtC,OAAO,IAAI,CAAC,UAAU,CAAC,EAAC,GAAG,EAAE,GAAG,EAAC,CAAC,CAAA;IACnC,CAAC;IAEM,SAAS;QACf,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,WAAW;YAAE,OAAO,KAAK,CAAA;QAC3C,IAAI,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,OAAO;YAAE,OAAO,WAAW,CAAC,KAAK,CAAA;;YACnD,OAAO,WAAW,CAAC,KAAK,CAAA;IAC9B,CAAC;IAED,wBAAwB;IAEjB,MAAM,CAAC,aAAa,CAAC,KAAa;QACxC,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aAC9E,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,MAAM,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACrF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,MAAM,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACrF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACnF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,KAAK,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACpF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aAEnF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACnF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,MAAM,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACrF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,MAAM,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACrF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACnF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,KAAK,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;aACpF,IAAI,KAAK,CAAC,IAAI,KAAK,UAAU,CAAC,IAAI,IAAI,KAAK,CAAC,KAAK,KAAK,WAAW,CAAC,KAAK;YAAE,OAAO,GAAG,CAAA;QAExF,OAAO,EAAE,CAAA;IACV,CAAC;IAEM,MAAM,CAAC,mBAAmB;QAEhC,MAAM,QAAQ,GAAG;YAChB,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,MAAM;YACjB,UAAU,CAAC,MAAM;YACjB,UAAU,CAAC,KAAK;YAChB,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,MAAM;YACjB,UAAU,CAAC,MAAM;YACjB,UAAU,CAAC,IAAI;SACf,CAAA;QAED,MAAM,QAAQ,GAAG;YAChB,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,IAAI;YACf,UAAU,CAAC,IAAI;SACf,CAAA;QAED,MAAM,QAAQ,GAAG,CAAC,SAA4B,EAAE,KAAkB,EAAE,EAAE;YACrE,OAAO,SAAS,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE,CAAC,CAAC,CAAA;QAChD,CAAC,CAAA;QAED,OAAO,CAAC;YACP,QAAQ,CAAC,QAAQ,EAAE,WAAW,CAAC,KAAK,CAAC;YACrC,QAAQ,CAAC,QAAQ,EAAE,WAAW,CAAC,KAAK,CAAC;YACrC,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC;YAChD,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC;YAChD,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC;YAChD,CAAC,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,EAAE,IAAI,CAAC;YAChD,QAAQ,CAAC,QAAQ,EAAE,WAAW,CAAC,KAAK,CAAC;YACrC,QAAQ,CAAC,QAAQ,EAAE,WAAW,CAAC,KAAK,CAAC;SACrC,CAAC,CAAA;IACH,CAAC;IAEM,MAAM,CAAC,oBAAoB;QACjC,OAAO,CAAC;YAEP,KAAK,EAAE;gBACN,OAAO,EAAE,KAAK;gBACd,YAAY,EAAE,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC;gBACtE,YAAY,EAAE,KAAK;gBACnB,gBAAgB,EAAE,KAAK;gBACvB,iBAAiB,EAAE,KAAK;aACxB;YAED,KAAK,EAAE;gBACN,OAAO,EAAE,KAAK;gBACd,YAAY,EAAE,CAAC,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,EAAE,KAAK,CAAC;gBACtE,YAAY,EAAE,KAAK;gBACnB,gBAAgB,EAAE,KAAK;gBACvB,iBAAiB,EAAE,KAAK;aACxB;YAED,WAAW,EAAE,KAAK;YAClB,WAAW,EAAE,KAAK;YAClB,WAAW,EAAE,WAAW,CAAC,KAAK;SAC9B,CAAC,CAAA;IACH,CAAC;IAEM,MAAM,CAAC,kBAAkB;QAC/B,OAAO;YACN,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YACxB,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YACxB,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YACxB,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YACxB,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YACxB,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YACxB,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;YACxB,CAAC,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC;SACxB,CAAA;IACF,CAAC;IAEM,MAAM,CAAC,cAAc,CAAC,QAA0B;QACtD,IAAI,OAAO,GAAG,SAAS,CAAC,kBAAkB,EAAE,CAAA;QAC5C,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC,EAAE,CAAC,OAAO,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,EAAE,CAAC,CAAA;QACnE,OAAO,OAAO,CAAA;IACf,CAAC;IAEM,MAAM,CAAC,iBAAiB,CAAC,QAAmB;QAClD,OAAO,MAAM,CAAC,YAAY,CAAC,QAAQ,CAAC,GAAG,GAAG,EAAE,CAAC,GAAG,CAAC,QAAQ,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,QAAQ,EAAE,CAAA;IAC9E,CAAC;IAEO,MAAM,CAAC,iBAAiB,CAC/B,IAAY,EACZ,QAAgB,EAChB,cAA2B,EAC3B,UAAkB,EAAE;QAEpB,IAAI,aAAa,GAAG,CAAC,GAAG,CAAE,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,EAAE,EAAE,CAAC,QAAQ,GAAG,IAAI,CAAC,GAAG,GAAG,CAAC,CAAC,CAAA;QACpE,OAAO,IAAI,CAAC,KAAK,CAAC,OAAO,GAAG,CAAC,cAAc,GAAG,aAAa,CAAC,CAAC,CAAA;IAC9D,CAAC;IAEQ,MAAM,CAAC,YAAY,CAC3B,IAAY,EACZ,QAAgB,EAChB,cAA2B,EAC3B,UAAkB,EAAE;QAEpB,OAAO,IAAI,GAAG,SAAS,CAAC,iBAAiB,CAAC,IAAI,EAAE,QAAQ,EAAE,cAAc,EAAE,OAAO,CAAC,CAAA;IACjF,CAAC;CAEH;AA/kBD,8BA+kBC","sourcesContent":["import _ from 'lodash'\r\n\r\nexport enum EPieceColor {\r\n\tWHITE = 'w',\r\n\tBLACK = 'b'\r\n}\r\n\r\nexport enum EPieceType {\r\n\tROOK = 'r',\r\n\tKNIGHT = 'n',\r\n\tBISHOP = 'b',\r\n\tKING = 'k',\r\n\tQUEEN = 'q',\r\n\tPAWN = 'p',\r\n}\r\n\r\nexport type TPiece = {\r\n\tcolor: EPieceColor,\r\n\ttype: EPieceType\r\n}\r\n\r\nexport type TBoard = Array<Array<TPiece | null>>\r\nexport type THeatMap = Array<Array<number>>\r\n\r\nexport type TPosition = {\r\n\trow: number,\r\n\tcol: number\r\n}\r\n\r\nexport type TSideStatus = {\r\n\tisCheck: boolean,\r\n\tenPassantArr: [boolean, boolean, boolean, boolean, boolean, boolean, boolean, boolean],\r\n\thasKingMoved: boolean,\r\n\thasLongRookMoved: boolean,\r\n\thasShortRookMoved: boolean,\r\n}\r\n\r\nexport type TStatus = {\r\n\twhite: TSideStatus,\r\n\tblack: TSideStatus,\r\n\r\n\tisCheckmate: boolean,\r\n\tisStalemate: boolean,\r\n\tcurrentTurn: EPieceColor,\t\r\n}\r\n\r\nexport class ChessCore {\r\n\r\n\t// Properties ------\r\n\r\n\tprivate _board: TBoard\r\n\tprivate _status: TStatus\r\n\t\r\n\tpublic get board() { return this._board }\r\n\tpublic set board(val: TBoard) { this._board = val }\r\n\r\n\tpublic get status() { return this._status }\r\n\tpublic set status(val: TStatus) { this._status = val }\r\n\r\n\t// Private Methods ------\r\n\r\n\tprivate static comparePieces(piece1: TPiece | null, piece2: TPiece | null): boolean {\r\n\t\tif (piece1 === null || piece2 === null) return false\r\n\t\telse if (piece1.type === piece2.type && piece1.color === piece2.color) return true\r\n\t\telse return false\r\n\t}\r\n\r\n\tprivate static checkBounds(position: TPosition): boolean {\r\n\t\tif (\r\n\t\t\tposition.row < 0 || \r\n\t\t\tposition.row > 7 ||\r\n\t\t\tposition.col < 0 ||\r\n\t\t\tposition.col > 7\r\n\t\t) return false\r\n\t\telse return true\r\n\t}\r\n\r\n\tprivate evaluateCheck(color: EPieceColor) {\r\n\t\tconst heatMap = ChessCore.movesToHeatMap(this.getAllMoves(color === EPieceColor.WHITE ? EPieceColor.BLACK : EPieceColor.WHITE, false, false))\r\n\t\tconst kPos = this.find({ type: EPieceType.KING, color }, false)[0]\r\n\t\t\r\n\t\tif (heatMap[kPos.row][kPos.col] > 0) return true\r\n\t\telse return false\r\n\t}\r\n\r\n\t// Public Methods ------\r\n\r\n\tpublic constructor(board?: TBoard, status?: TStatus) {\r\n\r\n\t\tthis._board = board ? _.cloneDeep(board) : ChessCore.createPristineBoard()\r\n\t\tthis._status = status ? _.cloneDeep(status) : ChessCore.createPristineStatus()\r\n\r\n\t}\r\n\r\n\tpublic getMoves(position: TPosition, allowSpecialMoves: boolean = true, preventCheck: boolean = true): Array<TPosition> {\r\n\r\n\t\tlet positionsArr: TPosition[] = []\r\n\t\tconst piece = this.getPieceAt(position)\r\n\r\n\t\tif (!piece) return positionsArr\r\n\r\n\t\tconst helper = (i: number, j: number) => ({row: i, col: j })\r\n\r\n\t\tconst tryAddPosition = (newPosition: TPosition, allowCapture = true): boolean => {\r\n\t\t\t// Return value indicates if further traversal is possible (true if yes, false is obstacle is encountered - own or opponent piece)\r\n\r\n\t\t\tif (!ChessCore.checkBounds(newPosition)) return false\r\n\t\t\tconst pieceThere = this.getPieceAt(newPosition)\r\n\r\n\t\t\tif (!pieceThere) {\r\n\t\t\t\tpositionsArr.push(newPosition)\r\n\t\t\t\treturn true\r\n\t\t\t}\r\n\t\t\telse if ((pieceThere.color !== piece.color) && allowCapture) {\r\n\t\t\t\tpositionsArr.push(newPosition)\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\t\t\telse return false\r\n\t\t}\r\n\r\n\t\tconst tryAddStraights = () => {\r\n\t\t\tfor (var i = position.row + 1; i < 8; i++) {\r\n\t\t\t\tif (!tryAddPosition(helper(i, position.col))) break\r\n\t\t\t}\r\n\t\t\tfor (var i = position.row - 1; i >= 0; i--) {\r\n\t\t\t\tif (!tryAddPosition(helper(i, position.col))) break\r\n\t\t\t}\r\n\t\t\tfor (var j = position.col + 1; j < 8; j++) {\r\n\t\t\t\tif (!tryAddPosition(helper(position.row, j))) break\r\n\t\t\t}\r\n\t\t\tfor (var j = position.col - 1; j >= 0; j--) {\r\n\t\t\t\tif (!tryAddPosition(helper(position.row, j))) break\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst tryAddDiagonals = () => {\r\n\t\t\tconst helper = (i: number, j: number) => ({row: i, col: j })\r\n\r\n\t\t\tfor (var i = position.row + 1, j = position.col + 1; (i < 8) && (j < 8); i++, j++) {\r\n\t\t\t\tif (!tryAddPosition(helper(i, j))) break\r\n\t\t\t}\r\n\t\t\tfor (var i = position.row - 1, j = position.col - 1; (i >= 0) && (j >= 0); i--, j--) {\r\n\t\t\t\tif (!tryAddPosition(helper(i, j))) break\r\n\t\t\t}\r\n\t\t\tfor (var i = position.row + 1, j = position.col - 1; (i < 8) && (j >= 0); i++, j--) {\r\n\t\t\t\tif (!tryAddPosition(helper(i, j))) break\r\n\t\t\t}\r\n\t\t\tfor (var i = position.row - 1, j = position.col + 1; (i >= 0) && (j < 8); i--, j++) {\r\n\t\t\t\tif (!tryAddPosition(helper(i, j))) break\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Calculate moves\r\n\r\n\t\tif (piece.type === EPieceType.ROOK) {\r\n\t\t\ttryAddStraights()\r\n\t\t}\r\n\r\n\t\telse if (piece.type === EPieceType.KNIGHT) {\r\n\t\t\ttryAddPosition(helper(position.row + 1, position.col + 2))\r\n\t\t\ttryAddPosition(helper(position.row + 2, position.col + 1))\r\n\t\t\ttryAddPosition(helper(position.row - 1, position.col - 2))\r\n\t\t\ttryAddPosition(helper(position.row - 2, position.col - 1))\r\n\t\t\ttryAddPosition(helper(position.row + 1, position.col - 2))\r\n\t\t\ttryAddPosition(helper(position.row - 1, position.col + 2))\r\n\t\t\ttryAddPosition(helper(position.row + 2, position.col - 1))\r\n\t\t\ttryAddPosition(helper(position.row - 2, position.col + 1))\r\n\t\t}\r\n\r\n\t\telse if (piece.type === EPieceType.BISHOP) {\r\n\t\t\ttryAddDiagonals()\r\n\t\t}\r\n\r\n\t\telse if (piece.type === EPieceType.KING) {\r\n\t\t\ttryAddPosition(helper(position.row + 1, position.col + 1))\r\n\t\t\ttryAddPosition(helper(position.row + 1, position.col))\r\n\t\t\ttryAddPosition(helper(position.row - 1, position.col))\r\n\t\t\ttryAddPosition(helper(position.row, position.col + 1))\r\n\t\t\ttryAddPosition(helper(position.row, position.col - 1))\r\n\t\t\ttryAddPosition(helper(position.row - 1, position.col - 1))\r\n\t\t\ttryAddPosition(helper(position.row + 1, position.col - 1))\r\n\t\t\ttryAddPosition(helper(position.row - 1, position.col + 1))\r\n\r\n\t\t\t// Castle\r\n\t\t\tif (allowSpecialMoves) {\r\n\t\t\t\tif (piece.color === EPieceColor.WHITE) {\r\n\t\t\t\t\tif (!this.status.white.hasKingMoved && !this.status.white.isCheck) {\r\n\t\t\t\t\t\tconst BHeatMap = ChessCore.movesToHeatMap(this.getAllMoves(EPieceColor.BLACK, false, false))\r\n\r\n\t\t\t\t\t\tif (!this.status.white.hasShortRookMoved) {\r\n\t\t\t\t\t\t\tif (!this.pieceAt(0, 5) && !this.pieceAt(0, 6)) {\r\n\t\t\t\t\t\t\t\tif (!BHeatMap[0][5] && !BHeatMap[0][6]) tryAddPosition(helper(0, 6), false)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (!this.status.white.hasLongRookMoved) {\r\n\t\t\t\t\t\t\tif (!this.pieceAt(0, 1) && !this.pieceAt(0, 2) && !this.pieceAt(0, 3)) {\r\n\t\t\t\t\t\t\t\tif (!BHeatMap[0][1] && !BHeatMap[0][2] && !BHeatMap[0][3]) tryAddPosition(helper(0, 2), false)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\telse {\r\n\t\t\t\t\tif (!this.status.black.hasKingMoved && !this.status.black.isCheck) {\r\n\t\t\t\t\t\tconst WHeatMap = ChessCore.movesToHeatMap(this.getAllMoves(EPieceColor.WHITE, false, false))\r\n\r\n\t\t\t\t\t\tif (!this.status.black.hasShortRookMoved) {\r\n\t\t\t\t\t\t\tif (!this.pieceAt(7, 5) && !this.pieceAt(7, 6)) {\r\n\t\t\t\t\t\t\t\tif (!WHeatMap[7][5] && !WHeatMap[7][6]) tryAddPosition(helper(7, 6), false)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t\tif (!this.status.black.hasLongRookMoved) {\r\n\t\t\t\t\t\t\tif (!this.pieceAt(7, 1) && !this.pieceAt(7, 2) && !this.pieceAt(7, 3)) {\r\n\t\t\t\t\t\t\t\tif (!WHeatMap[7][1] && !WHeatMap[7][2] && !WHeatMap[7][3]) tryAddPosition(helper(7, 2), false)\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\t\r\n\t\t}\r\n\r\n\t\telse if (piece.type === EPieceType.QUEEN) {\r\n\t\t\ttryAddStraights()\r\n\t\t\ttryAddDiagonals()\r\n\t\t}\r\n\r\n\t\telse if (piece.type === EPieceType.PAWN) {\r\n\r\n\t\t\tif (piece.color === EPieceColor.WHITE) {\r\n\r\n\t\t\t\ttryAddPosition(helper(position.row + 1, position.col), false)\r\n\t\t\t\tif (position.row === 1) tryAddPosition(helper(position.row + 2, position.col), false)\r\n\t\t\t\t\r\n\t\t\t\tlet pieceThere = this.pieceAt(position.row + 1, position.col + 1)\r\n\t\t\t\tif (pieceThere && pieceThere.color === EPieceColor.BLACK) tryAddPosition(helper(position.row + 1, position.col + 1))\r\n\r\n\t\t\t\tpieceThere = this.pieceAt(position.row + 1, position.col - 1)\r\n\t\t\t\tif (pieceThere && pieceThere.color === EPieceColor.BLACK) tryAddPosition(helper(position.row + 1, position.col - 1))\r\n\r\n\t\t\t\t// En passant\r\n\t\t\t\tif (allowSpecialMoves && position.row === 4) {\r\n\t\t\t\t\tpieceThere = this.pieceAt(position.row, position.col + 1)\t\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tpieceThere && \r\n\t\t\t\t\t\tpieceThere.color === EPieceColor.BLACK && \r\n\t\t\t\t\t\tpieceThere.type === EPieceType.PAWN && \r\n\t\t\t\t\t\tthis.status.black.enPassantArr[position.col + 1]\r\n\t\t\t\t\t) tryAddPosition(helper(position.row + 1, position.col + 1))\t\r\n\r\n\t\t\t\t\tpieceThere = this.pieceAt(position.row, position.col - 1)\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tpieceThere && \r\n\t\t\t\t\t\tpieceThere.color === EPieceColor.BLACK && \r\n\t\t\t\t\t\tpieceThere.type === EPieceType.PAWN && \r\n\t\t\t\t\t\tthis.status.black.enPassantArr[position.col - 1]\r\n\t\t\t\t\t) tryAddPosition(helper(position.row + 1, position.col - 1))\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t}\r\n\r\n\t\t\telse {\r\n\r\n\t\t\t\ttryAddPosition(helper(position.row - 1, position.col), false)\r\n\t\t\t\tif (position.row === 6) tryAddPosition(helper(position.row - 2, position.col), false)\r\n\r\n\t\t\t\tlet pieceThere = this.pieceAt(position.row - 1, position.col + 1)\r\n\t\t\t\tif (pieceThere && pieceThere.color === EPieceColor.WHITE) tryAddPosition(helper(position.row - 1, position.col + 1))\r\n\r\n\t\t\t\tpieceThere = this.pieceAt(position.row - 1, position.col - 1)\r\n\t\t\t\tif (pieceThere && pieceThere.color === EPieceColor.WHITE) tryAddPosition(helper(position.row - 1, position.col - 1))\r\n\r\n\t\t\t\t// En passant\r\n\t\t\t\tif (allowSpecialMoves && position.row === 3) {\r\n\t\t\t\t\tpieceThere = this.pieceAt(position.row, position.col + 1)\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tpieceThere &&\r\n\t\t\t\t\t\tpieceThere.color === EPieceColor.WHITE &&\r\n\t\t\t\t\t\tpieceThere.type === EPieceType.PAWN && \r\n\t\t\t\t\t\tthis.status.white.enPassantArr[position.col + 1]\r\n\t\t\t\t\t) tryAddPosition(helper(position.row - 1, position.col + 1))\r\n\r\n\t\t\t\t\tpieceThere = this.pieceAt(position.row, position.col - 1)\r\n\t\t\t\t\tif (\r\n\t\t\t\t\t\tpieceThere &&\r\n\t\t\t\t\t\tpieceThere.color === EPieceColor.WHITE &&\r\n\t\t\t\t\t\tpieceThere.type === EPieceType.PAWN && \r\n\t\t\t\t\t\tthis.status.white.enPassantArr[position.col - 1]\r\n\t\t\t\t\t) tryAddPosition(helper(position.row - 1, position.col - 1))\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t// Filter moves that create or continue own check\r\n\r\n\t\tif (preventCheck) {\r\n\t\t\tconst tryResolveCheck = (startPosition: TPosition, endPosition: TPosition) => {\r\n\t\t\t\tconst p1 = this.getPieceAt(startPosition)!, p2 = this.getPieceAt(endPosition)\r\n\r\n\t\t\t\tthis._board[endPosition.row][endPosition.col] = p1\r\n\t\t\t\tthis._board[startPosition.row][startPosition.col] = null\r\n\t\t\t\t\r\n\t\t\t\tlet isResolved = false\r\n\t\t\t\tif (!this.evaluateCheck(p1.color)) isResolved = true\r\n\r\n\t\t\t\tthis._board[endPosition.row][endPosition.col] = p2\r\n\t\t\t\tthis._board[startPosition.row][startPosition.col] = p1\r\n\r\n\t\t\t\treturn isResolved\r\n\t\t\t}\r\n\t\t\tpositionsArr = positionsArr.filter(endPosition => tryResolveCheck(position, endPosition))\r\n\t\t}\r\n\r\n\t\t// All done\r\n\r\n\t\treturn positionsArr\r\n\r\n\t}\r\n\r\n\tpublic getAllMoves(color: EPieceColor, allowSpecialMoves: boolean = true, preventCheck: boolean = true): Array<TPosition> {\r\n\t\tlet positionsArr: TPosition[] = []\r\n\r\n\t\tfor(var i = 0; i < 8; i++) {\r\n\t\t\tfor (var j = 0; j < 8; j++) {\r\n\t\t\t\tconst piece = this.pieceAt(i, j)\r\n\t\t\t\tif (piece && piece.color === color) {\r\n\t\t\t\t\tpositionsArr.push(...this.getMoves({row: i, col: j}, allowSpecialMoves, preventCheck))\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn positionsArr\r\n\t}\r\n\r\n\tpublic makeMove(startPosition: TPosition, endPosition: TPosition, enforceTurns: boolean = true): TPiece | null | false {\r\n\t\t\r\n\t\t// 1. Check if we got a piece\r\n\t\t// 2. Check if it's a valid move\r\n\t\t// 3. Execute the move\r\n\t\t// 4. Update status\t\r\n\r\n\t\t// Step 1\t\r\n\t\tconst piece = this.getPieceAt(startPosition)\r\n\t\tlet capturedPiece = this.getPieceAt(endPosition)\r\n\t\tif (!piece) return false \r\n\r\n\t\t// Helpers\r\n\t\tconst oppColor = piece.color === EPieceColor.WHITE ? EPieceColor.BLACK : EPieceColor.WHITE\r\n\t\tconst oppColorStr = piece.color === EPieceColor.WHITE ? 'black' : 'white'\r\n\t\tconst sameColorStr = piece.color === EPieceColor.WHITE ? 'white' : 'black'\r\n\r\n\t\t// Step 2\r\n\t\tif (enforceTurns && this._status.currentTurn !== piece.color) return false\r\n\t\tconst moves = this.getMoves(startPosition, true)\r\n\t\tconst movesHeatMap = ChessCore.movesToHeatMap(moves)\r\n\t\tif (!movesHeatMap[endPosition.row][endPosition.col]) return false \r\n\r\n\t\t// Step 3\r\n\t\tthis._board[endPosition.row][endPosition.col] = piece \r\n\t\tthis._board[startPosition.row][startPosition.col] = null\t\r\n\r\n\t\t// Sub-step 4 - Determine castle status, optionally perform castle\r\n\t\tif (piece.type === EPieceType.KING) {\r\n\t\t\tif (!this._status[sameColorStr].hasKingMoved) {\r\n\t\t\t\tif (endPosition.col === 2) {\r\n\t\t\t\t\tthis._board[piece.color === EPieceColor.WHITE ? 0 : 7][3] = { type: EPieceType.ROOK, color: piece.color }\r\n\t\t\t\t\tthis._board[piece.color === EPieceColor.WHITE ? 0 : 7][0] = null\r\n\t\t\t\t\tthis._status[sameColorStr].hasShortRookMoved = true\r\n\t\t\t\t}\r\n\t\t\t\telse if (endPosition.col === 6) {\r\n\t\t\t\t\tthis._board[piece.color === EPieceColor.WHITE ? 0 : 7][5] = { type: EPieceType.ROOK, color: piece.color }\r\n\t\t\t\t\tthis._board[piece.color === EPieceColor.WHITE ? 0 : 7][7] = null\r\n\t\t\t\t\tthis._status[sameColorStr].hasLongRookMoved = true\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tthis._status[sameColorStr].hasKingMoved = true\r\n\t\t}\r\n\t\telse if (piece.type === EPieceType.ROOK) {\r\n\t\t\tif (startPosition.col === 0) this._status[sameColorStr].hasLongRookMoved = true\r\n\t\t\telse if (startPosition.col === 7) this._status[sameColorStr].hasShortRookMoved = true\r\n\t\t}\r\n\r\n\t\t// Sub-step 4 - Update opponent's castle status if their rook dies\r\n\t\tif (capturedPiece && capturedPiece.type === EPieceType.ROOK) {\r\n\t\t\tif (!this._status[oppColorStr].hasShortRookMoved && endPosition.col === 7) {\r\n\t\t\t\tif ((oppColor === EPieceColor.BLACK && endPosition.row === 7) || \r\n\t\t\t\t\t(oppColor === EPieceColor.WHITE && endPosition.row === 0)) this._status[oppColorStr].hasShortRookMoved = true\r\n\t\t\t}\r\n\t\t\telse if (!this._status[oppColorStr].hasLongRookMoved && endPosition.col === 0) {\r\n\t\t\t\tif ((oppColor === EPieceColor.BLACK && endPosition.row === 7) || \r\n\t\t\t\t\t(oppColor === EPieceColor.WHITE && endPosition.row === 0)) this._status[oppColorStr].hasLongRookMoved = true\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\t// Sub-step 4 - En Passant and promotion\r\n\t\tif (piece.type === EPieceType.PAWN) {\r\n\r\n\t\t\t// Update own En passant status\r\n\t\t\tif (piece.color === EPieceColor.WHITE) {\r\n\t\t\t\tif (startPosition.row === 1 && endPosition.row === 3) this._status[sameColorStr].enPassantArr[startPosition.col] = true\r\n\t\t\t\telse this._status[sameColorStr].enPassantArr[startPosition.col] = false\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tif (startPosition.row === 6 && endPosition.row === 4) this._status[sameColorStr].enPassantArr[startPosition.col] = true\r\n\t\t\t\telse this._status[sameColorStr].enPassantArr[startPosition.col] = false\r\n\t\t\t}\r\n\r\n\t\t\t// Perform en passant\r\n\t\t\tif (piece.color === EPieceColor.WHITE) {\r\n\t\t\t\tif (startPosition.row === 4 && \r\n\t\t\t\t\tendPosition.row === 5 &&\r\n\t\t\t\t\t!capturedPiece &&\r\n\t\t\t\t\tthis._status[oppColorStr].enPassantArr[endPosition.col] &&\r\n\t\t\t\t\t(endPosition.col === startPosition.col - 1 || \r\n\t\t\t\t\tendPosition.col === startPosition.col + 1)) {\r\n\r\n\t\t\t\t\tconst targetPiece = this.pieceAt(4, endPosition.col)\r\n\t\t\t\t\tif (targetPiece && \r\n\t\t\t\t\t\ttargetPiece.type === EPieceType.PAWN && \r\n\t\t\t\t\t\ttargetPiece.color === oppColor) {\r\n\t\t\t\t\t\t\tcapturedPiece = targetPiece\r\n\t\t\t\t\t\t\tthis._board[4][endPosition.col] = null\r\n\t\t\t\t\t\t}\r\n\t\t\t\t} \t\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tif (startPosition.row === 3 && \r\n\t\t\t\t\tendPosition.row === 2 &&\r\n\t\t\t\t\t!capturedPiece &&\r\n\t\t\t\t\tthis._status[oppColorStr].enPassantArr[endPosition.col] &&\r\n\t\t\t\t\t(endPosition.col === startPosition.col - 1 || \r\n\t\t\t\t\tendPosition.col === startPosition.col + 1)) {\r\n\r\n\t\t\t\t\tconst targetPiece = this.pieceAt(3, endPosition.col)\r\n\t\t\t\t\tif (targetPiece && \r\n\t\t\t\t\t\ttargetPiece.type === EPieceType.PAWN && \r\n\t\t\t\t\t\ttargetPiece.color === oppColor) {\r\n\t\t\t\t\t\t\tcapturedPiece = targetPiece\r\n\t\t\t\t\t\t\tthis._board[3][endPosition.col] = null\r\n\t\t\t\t\t\t}\r\n\t\t\t\t} \t\r\n\t\t\t}\r\n\r\n\t\t\t// Perform Promotion\r\n\t\t\tif (piece.color === EPieceColor.WHITE && endPosition.row === 7) {\r\n\t\t\t\tthis._board[endPosition.row][endPosition.col] = { type: EPieceType.QUEEN, color: piece.color}\r\n\t\t\t}\r\n\t\t\telse if (piece.color === EPieceColor.BLACK && endPosition.row === 0) {\r\n\t\t\t\tthis._board[endPosition.row][endPosition.col] = { type: EPieceType.QUEEN, color: piece.color}\r\n\t\t\t}\r\n\r\n\t\t}\r\n\r\n\t\t// Sub-step 4 - Reset Opp en passant\r\n\t\tthis._status[oppColorStr].enPassantArr = [false, false, false, false, false, false, false, false]\r\n\r\n\t\t// Sub-step 4 - Determine check status - opponent\r\n\t\tif (this.getAllMoves(oppColor, true).length === 0) {\r\n\t\t\tif (this.evaluateCheck(oppColor)) {\r\n\t\t\t\tthis._status[oppColorStr].isCheck = true\r\n\t\t\t\tthis._status.isCheckmate = true\r\n\t\t\t}\r\n\t\t\telse this._status.isStalemate = true\r\n\t\t}\r\n\t\telse if (this.evaluateCheck(oppColor)) {\r\n\t\t\tthis._status[oppColorStr].isCheck = true\r\n\t\t}\r\n\r\n\t\t// Sub-step 4 - reset check own status\r\n\t\tthis._status[piece.color === EPieceColor.WHITE ? 'white' : 'black'].isCheck = false\r\n\r\n\t\t// Sub-step 4 - Update turn\r\n\t\tthis._status.currentTurn = oppColor\r\n\r\n\t\t// All done\r\n\t\treturn capturedPiece\r\n\r\n\t}\r\n\r\n\tpublic find(piece: TPiece, findAll: boolean = false): Array<TPosition> {\r\n\t\tlet positionsArr: TPosition[] = []\r\n\r\n\t\tfor (var i = 0; i < 8; i++) {\r\n\t\t\tfor (var j = 0; j < 8; j++) {\r\n\t\t\t\tif (ChessCore.comparePieces(this._board[i][j], piece)) {\r\n\t\t\t\t\tpositionsArr.push({row: i, col: j})\r\n\t\t\t\t\tif (!findAll) return positionsArr\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\treturn positionsArr\r\n\t}\r\n\r\n\tpublic getPieceAt(position: TPosition): TPiece | null {\r\n\t\treturn this._board[position.row][position.col]\r\n\t}\r\n\r\n\tpublic pieceAt(row: number, col: number): TPiece | null {\r\n\t\treturn this.getPieceAt({row, col})\r\n\t}\r\n\r\n\tpublic getWinner(): EPieceColor | false {\r\n\t\tif (!this._status.isCheckmate) return false\r\n\t\tif (this._status.black.isCheck) return EPieceColor.WHITE\r\n\t\telse return EPieceColor.BLACK\r\n\t}\r\n\r\n\t// Static Methods ------\r\n\r\n\tpublic static pieceToSymbol(piece: TPiece): string {\r\n\t\tif (piece.type === EPieceType.ROOK && piece.color === EPieceColor.WHITE) return 'r'\r\n\t\telse if (piece.type === EPieceType.KNIGHT && piece.color === EPieceColor.WHITE) return 'h'\r\n\t\telse if (piece.type === EPieceType.BISHOP && piece.color === EPieceColor.WHITE) return 'b'\r\n\t\telse if (piece.type === EPieceType.KING && piece.color === EPieceColor.WHITE) return 'k'\r\n\t\telse if (piece.type === EPieceType.QUEEN && piece.color === EPieceColor.WHITE) return 'q'\r\n\t\telse if (piece.type === EPieceType.PAWN && piece.color === EPieceColor.WHITE) return 'p'\r\n\r\n\t\telse if (piece.type === EPieceType.ROOK && piece.color === EPieceColor.BLACK) return 't'\r\n\t\telse if (piece.type === EPieceType.KNIGHT && piece.color === EPieceColor.BLACK) return 'j'\r\n\t\telse if (piece.type === EPieceType.BISHOP && piece.color === EPieceColor.BLACK) return 'n'\r\n\t\telse if (piece.type === EPieceType.KING && piece.color === EPieceColor.BLACK) return 'l'\r\n\t\telse if (piece.type === EPieceType.QUEEN && piece.color === EPieceColor.BLACK) return 'w'\r\n\t\telse if (piece.type === EPieceType.PAWN && piece.color === EPieceColor.BLACK) return 'o'\r\n\t\t\r\n\t\treturn ''\r\n\t}\r\n\r\n\tpublic static createPristineBoard(): TBoard {\r\n\r\n\t\tconst mainLine = [\r\n\t\t\tEPieceType.ROOK,\r\n\t\t\tEPieceType.KNIGHT,\r\n\t\t\tEPieceType.BISHOP,\t\r\n\t\t\tEPieceType.QUEEN,\r\n\t\t\tEPieceType.KING,\r\n\t\t\tEPieceType.BISHOP,\r\n\t\t\tEPieceType.KNIGHT,\r\n\t\t\tEPieceType.ROOK\r\n\t\t]\r\n\r\n\t\tconst pawnLine = [\r\n\t\t\tEPieceType.PAWN,\r\n\t\t\tEPieceType.PAWN,\r\n\t\t\tEPieceType.PAWN,\r\n\t\t\tEPieceType.PAWN,\r\n\t\t\tEPieceType.PAWN,\r\n\t\t\tEPieceType.PAWN,\r\n\t\t\tEPieceType.PAWN,\r\n\t\t\tEPieceType.PAWN\r\n\t\t]\r\n\r\n\t\tconst addColor = (pieceLine: Array<EPieceType>, color: EPieceColor) => {\r\n\t\t\treturn pieceLine.map(type => ({ type, color }))\r\n\t\t}\r\n\r\n\t\treturn ([\r\n\t\t\taddColor(mainLine, EPieceColor.WHITE),\r\n\t\t\taddColor(pawnLine, EPieceColor.WHITE),\r\n\t\t\t[null, null, null, null, null, null, null, null],\r\n\t\t\t[null, null, null, null, null, null, null, null],\r\n\t\t\t[null, null, null, null, null, null, null, null],\r\n\t\t\t[null, null, null, null, null, null, null, null],\r\n\t\t\taddColor(pawnLine, EPieceColor.BLACK),\r\n\t\t\taddColor(mainLine, EPieceColor.BLACK),\r\n\t\t])\r\n\t}\r\n\r\n\tpublic static createPristineStatus(): TStatus {\r\n\t\treturn ({\r\n\r\n\t\t\twhite: {\r\n\t\t\t\tisCheck: false,\r\n\t\t\t\tenPassantArr: [false, false, false, false, false, false, false, false],\r\n\t\t\t\thasKingMoved: false,\r\n\t\t\t\thasLongRookMoved: false,\r\n\t\t\t\thasShortRookMoved: false,\r\n\t\t\t},\r\n\r\n\t\t\tblack: {\r\n\t\t\t\tisCheck: false,\r\n\t\t\t\tenPassantArr: [false, false, false, false, false, false, false, false],\r\n\t\t\t\thasKingMoved: false,\r\n\t\t\t\thasLongRookMoved: false,\r\n\t\t\t\thasShortRookMoved: false,\r\n\t\t\t},\r\n\r\n\t\t\tisCheckmate: false,\r\n\t\t\tisStalemate: false,\r\n\t\t\tcurrentTurn: EPieceColor.WHITE,\r\n\t\t})\r\n\t}\r\n\r\n\tpublic static createBlankHeatMap(): THeatMap {\r\n\t\treturn [\r\n\t\t\t[0, 0, 0, 0, 0, 0, 0, 0],\r\n\t\t\t[0, 0, 0, 0, 0, 0, 0, 0],\r\n\t\t\t[0, 0, 0, 0, 0, 0, 0, 0],\r\n\t\t\t[0, 0, 0, 0, 0, 0, 0, 0],\r\n\t\t\t[0, 0, 0, 0, 0, 0, 0, 0],\r\n\t\t\t[0, 0, 0, 0, 0, 0, 0, 0],\r\n\t\t\t[0, 0, 0, 0, 0, 0, 0, 0],\r\n\t\t\t[0, 0, 0, 0, 0, 0, 0, 0],\r\n\t\t]\r\n\t}\r\n\r\n\tpublic static movesToHeatMap(movesArr: Array<TPosition>): THeatMap {\r\n\t\tlet heatMap = ChessCore.createBlankHeatMap()\r\n\t\tmovesArr.forEach(position => heatMap[position.row][position.col]++)\r\n\t\treturn heatMap\r\n\t}\r\n\r\n\tpublic static translatePosition(position: TPosition): string {\r\n\t\treturn String.fromCharCode(position.col + 97) + (position.row + 1).toString()\r\n\t}\r\n\r\n\tprivate static calculateEloDelta(\r\n\t\tself: number, \r\n\t\topponent: number, \r\n\t\tselfGameResult: 0 | 1 | 0.5, \r\n\t\tkFactor: number = 32\r\n\t) {\r\n\t\tvar myChanceToWin = 1 / ( 1 + Math.pow(10, (opponent - self) / 400))\r\n\t\treturn Math.round(kFactor * (selfGameResult - myChanceToWin))\r\n\t}\r\n\r\n  \tpublic static calculateElo(\r\n\t\tself: number, \r\n\t\topponent: number, \r\n\t\tselfGameResult: 0 | 1 | 0.5, \r\n\t\tkFactor: number = 32\r\n\t) {\r\n\t\treturn self + ChessCore.calculateEloDelta(self, opponent, selfGameResult, kFactor)\r\n  \t}\r\n\r\n}"]}